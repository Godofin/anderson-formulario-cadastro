<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Eventos e Linktree</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f4f4f4;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
        }

        /* --- ESTILOS DAS ABAS DE NAVEGA√á√ÉO --- */
        .admin-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .admin-nav button {
            background-color: #bdc3c7;
            color: #2c3e50;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .admin-nav button:hover {
            background-color: #95a5a6;
        }
        .admin-nav button.active {
            background-color: #2c3e50;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        @media (min-width: 600px) {
            form {
                grid-template-columns: 1fr 1fr;
            }
            .full-width {
                grid-column: 1 / -1;
            }
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        input[type="text"],
        input[type="url"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="checkbox"] {
            width: auto;
        }
        
        /* Bot√µes Gerais */
        .btn-primary {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-secondary {
            background-color: #7f8c8d;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #6c7a7d;
        }
        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
        }

        /* Estilos das Listas (Comum) */
        .item-list { margin-top: 30px; }
        .list-item {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .item-details { flex-grow: 1; }
        .item-details strong {
            font-size: 1.1em;
            color: #2c3e50;
        }
        .item-details .status {
            font-style: italic;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .item-actions button {
            background-color: #e67e22;
            color: white;
            border: none;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 4px;
            margin-left: 5px;
            cursor: pointer;
        }
        .item-actions button:hover { background-color: #d35400; }
        .item-actions .delete-btn { background-color: #e74c3c; }
        .item-actions .delete-btn:hover { background-color: #c0392b; }
        
        .loading {
            text-align: center;
            font-size: 1.2em;
            padding: 20px;
        }
        .search-container { margin-bottom: 20px; }

        /* Espec√≠fico Linktree */
        .preview-img {
            max-width: 50px;
            max-height: 50px;
            border-radius: 4px;
            object-fit: cover;
            margin-right: 15px;
            display: block;
        }
        .link-header {
            display: flex;
            align-items: center;
        }

        /* Espec√≠fico Eventos (Switch Toggle) */
        .link-type-container {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 5px;
        }
        .switch-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #25D366; /* Verde WhatsApp */
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #3498db; }
        input:checked + .slider:before { transform: translateX(26px); }
        .whatsapp-preview {
            font-size: 0.85em;
            color: #666;
            word-break: break-all;
            background: #e8f5e9;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #25D366;
            margin-top: 5px;
        }

        /* Oculta se√ß√µes n√£o ativas */
        .view-section {
            display: none;
        }
        .view-section.active {
            display: block;
        }
    </style>
</head>
<body>

    <!-- NAVEGA√á√ÉO -->
    <div class="admin-nav">
        <button id="tab-events" class="active" onclick="switchTab('events')">Gerenciar Eventos</button>
        <button id="tab-linktree" onclick="switchTab('linktree')">Gerenciar Linktree</button>
    </div>

    <!-- ========================================== -->
    <!-- SESS√ÉO: GERENCIAR EVENTOS                  -->
    <!-- ========================================== -->
    <div id="section-events" class="view-section active">
        <div class="container">
            <h1 id="event-form-title">Cadastrar Novo Evento</h1>
            <form id="event-form">
                <input type="hidden" id="event-id">

                <div>
                    <label for="event-title">T√≠tulo do Evento:</label>
                    <input type="text" id="event-title" name="title" required placeholder="Ex: Show da Xuxa">
                </div>
                
                <input type="hidden" id="eventName" name="eventName">

                <div>
                    <label for="event-image">URL da Imagem:</label>
                    <input type="url" id="event-image" name="image" required>
                </div>
                
                <div>
                    <label for="event-alt">Tipo do Evento:</label>
                    <select id="event-alt" name="alt" required>
                        <option value="" disabled selected>Selecione o tipo</option>
                        <option value="Ecoturismo/Viagens">Ecoturismo/Viagens</option>
                        <option value="Shows/Eventos">Shows/Eventos</option>
                    </select>
                </div>

                <div class="full-width">
                    <label for="event-description">Descri√ß√£o:</label>
                    <textarea id="event-description" name="description" required></textarea>
                </div>
                
                <div>
                    <label for="event-date-text">Data e Local (Texto):</label>
                    <input type="text" id="event-date-text" name="date" 
                            placeholder="Exemplo: 01 de Janeiro de 2025 - Est√°dio, Cidade/Estado" required>
                </div>

                <div>
                    <label for="event-date">Data do Evento (YYYY-MM-DD):</label>
                    <input type="date" id="event-date" name="date_event" required>
                </div>
                <div>
                    <label for="event-button-text">Texto do Bot√£o:</label>
                    <input type="text" id="event-button-text" name="buttonText" 
                            value="Reservar agora" 
                            placeholder="Ex: Reservar para 01 de Janeiro" required>
                </div>

                <!-- CONTROLE DE LINK (WHATSAPP vs ECOMMERCE) -->
                <div class="full-width link-type-container">
                    <label>Destino do Bot√£o de Reserva:</label>
                    
                    <div class="switch-wrapper">
                        <span style="font-size: 0.9em; color: #25D366; font-weight: bold;">WhatsApp Autom√°tico</span>
                        <label class="switch">
                            <input type="checkbox" id="link_type_toggle">
                            <span class="slider round"></span>
                        </label>
                        <span style="font-size: 0.9em; color: #3498db; font-weight: bold;">Link Personalizado</span>
                    </div>

                    <div id="whatsapp-panel">
                        <p style="margin: 0; font-size: 0.9em; color: #555;">O link ser√° gerado automaticamente para o n√∫mero <strong>(16) 98833-2631</strong>.</p>
                        <div id="whatsapp-preview-text" class="whatsapp-preview">
                            Aguardando t√≠tulo...
                        </div>
                    </div>

                    <div id="manual-link-panel" style="display: none;">
                        <label for="ecommerce_link_input" style="font-size: 0.9em;">Link do Produto (URL Completa):</label>
                        <input type="url" id="ecommerce_link_input" 
                                placeholder="https://sualoja.com.br/produto/excursao-x">
                    </div>

                    <input type="hidden" id="final_ecommerce_link" name="ecommerce_link">
                </div>
                
                <input type="hidden" id="event-year" name="year">
                
                <div class="full-width">
                    <label for="event-cities">Cidades (separadas por v√≠rgula):</label>
                    <input type="text" id="event-cities" name="cities" placeholder="Ex: S√£o Paulo, Rio de Janeiro, Belo Horizonte">
                </div>
                
                <div class="checkbox-group full-width">
                    <input type="checkbox" id="event-active" name="active_event" checked>
                    <label for="event-active">Evento Ativo?</label>
                </div>
                <div class="form-actions">
                    <button type="submit" id="event-submit-btn" class="btn-primary">Cadastrar Evento</button>
                    <button type="button" id="event-cancel-btn" class="btn-secondary" style="display: none;">Cancelar Edi√ß√£o</button>
                </div>
            </form>
        </div>

        <div class="container">
            <h2>Eventos Cadastrados</h2>
            <div class="search-container">
                <label for="event-search">Buscar Evento por T√≠tulo:</label>
                <input type="text" id="event-search" placeholder="Digite o t√≠tulo do evento..." style="width: 100%;">
            </div>
            <div id="event-loading" class="loading">Carregando eventos...</div>
            <div id="event-list" class="item-list"></div>
        </div>
    </div>


    <!-- ========================================== -->
    <!-- SESS√ÉO: GERENCIAR LINKTREE                 -->
    <!-- ========================================== -->
    <div id="section-linktree" class="view-section">
        <div class="container">
            <h1 id="link-form-title">Cadastrar Novo Link</h1>
            <form id="linktree-form">
                <input type="hidden" id="link-id">

                <div class="full-width">
                    <label for="link-name">Nome do Link (T√≠tulo):</label>
                    <input type="text" id="link-name" name="name" required placeholder="Ex: Lollapalooza 2024">
                </div>

                <div class="full-width">
                    <label for="link-image_url">URL da Imagem:</label>
                    <input type="url" id="link-image_url" name="image_url" required placeholder="https://exemplo.com/imagem.webp">
                </div>

                <div class="full-width">
                    <label for="link-whatsapp_url">URL do WhatsApp:</label>
                    <input type="url" id="link-whatsapp_url" name="whatsapp_url" required placeholder="http://wa.me/message/...">
                </div>

                <div class="checkbox-group full-width">
                    <input type="checkbox" id="link-active" name="active" checked>
                    <label for="link-active">Link Ativo?</label>
                </div>

                <div class="form-actions">
                    <button type="submit" id="link-submit-btn" class="btn-primary">Cadastrar Link</button>
                    <button type="button" id="link-cancel-btn" class="btn-secondary" style="display: none;">Cancelar Edi√ß√£o</button>
                </div>
            </form>
        </div>

        <div class="container">
            <h2>Links Cadastrados</h2>
            <div class="search-container">
                <label for="link-search">Buscar Link por Nome:</label>
                <input type="text" id="link-search" placeholder="Digite o nome do link..." style="width: 100%;">
            </div>
            <div id="link-loading" class="loading">Carregando links...</div>
            <div id="link-list" class="item-list"></div>
        </div>
    </div>


    <!-- ========================================== -->
    <!-- SCRIPTS                                    -->
    <!-- ========================================== -->
    <script>
        // CONFIGURA√á√ïES GERAIS
        const apiBase = "https://fast-api-anderson.vercel.app/api/v1";
        const eventsApiUrl = `${apiBase}/events`;
        const linktreeApiUrl = `${apiBase}/linktree`;

        // Fun√ß√£o para alternar as abas
        function switchTab(tabName) {
            // Remove classes ativas
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.admin-nav button').forEach(el => el.classList.remove('active'));
            
            // Adiciona classes ativas aos selecionados
            document.getElementById(`section-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ====================================================
        // L√ìGICA DE EVENTOS
        // ====================================================
        const whatsappPhone = "5516988332631";
        const whatsappBaseMsg = "Ol√°! Tenho interesse na excurs√£o para o evento";

        const eventForm = document.getElementById('event-form');
        const eventIdInput = document.getElementById('event-id');
        const eventFormTitle = document.getElementById('event-form-title');
        const eventSubmitBtn = document.getElementById('event-submit-btn');
        const eventCancelBtn = document.getElementById('event-cancel-btn');
        const eventList = document.getElementById('event-list');
        const eventLoadingDiv = document.getElementById('event-loading');
        const eventSearchInput = document.getElementById('event-search');

        const linkTypeToggle = document.getElementById('link_type_toggle');
        const whatsappPanel = document.getElementById('whatsapp-panel');
        const whatsappPreviewText = document.getElementById('whatsapp-preview-text');
        const manualLinkPanel = document.getElementById('manual-link-panel');
        const ecommerceLinkInput = document.getElementById('ecommerce_link_input');
        const eventTitleInput = document.getElementById('event-title');
        
        let eventsCache = [];

        function generateWhatsappUrl(eventName) {
            if (!eventName) return "";
            const msg = `${whatsappBaseMsg} ${eventName}. Gostaria de mais informa√ß√µes.`;
            return `https://api.whatsapp.com/send?phone=${whatsappPhone}&text=${encodeURIComponent(msg)}`;
        }

        function updateEventLinkUI() {
            const isManual = linkTypeToggle.checked;
            const currentTitle = eventTitleInput.value;

            if (isManual) {
                whatsappPanel.style.display = 'none';
                manualLinkPanel.style.display = 'block';
                ecommerceLinkInput.setAttribute('required', 'true');
            } else {
                whatsappPanel.style.display = 'block';
                manualLinkPanel.style.display = 'none';
                ecommerceLinkInput.removeAttribute('required');
                ecommerceLinkInput.value = ''; 

                const generatedLink = generateWhatsappUrl(currentTitle);
                whatsappPreviewText.textContent = generatedLink || "Digite o t√≠tulo do evento para ver o link...";
            }
        }

        linkTypeToggle.addEventListener('change', updateEventLinkUI);
        eventTitleInput.addEventListener('input', updateEventLinkUI);

        function renderEvents(eventsToDisplay) {
            eventList.innerHTML = ''; 
            if (eventsToDisplay.length === 0) {
                eventList.innerHTML = '<p>Nenhum evento encontrado.</p>';
                return;
            }
            eventsToDisplay.forEach(event => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="item-details">
                        <strong>${event.title} (${event.year || 'Sem ano'})</strong>
                        <div>Tipo: ${event.alt || 'N√£o definido'}</div>
                        <div>Data Texto: ${event.date}</div>
                        <div>Data ID: ${event.date_event}</div>
                        <div class="status">${event.active_event ? 'üü¢ Ativo' : 'üî¥ Inativo'} | ID: ${event.id}</div>
                        ${event.ecommerce_link ? `<div><a href="${event.ecommerce_link}" target="_blank" style="color: #3498db;">üîó Link Bot√£o</a></div>` : ''}
                    </div>
                    <div class="item-actions">
                        <button onclick="editEvent(${event.id})">Editar</button>
                        <button class="delete-btn" onclick="deleteEvent(${event.id})">Excluir</button>
                    </div>
                `;
                eventList.appendChild(item);
            });
        }
        
        async function fetchEvents() {
            eventLoadingDiv.style.display = 'block';
            eventList.innerHTML = '';
            try {
                const response = await fetch(`${eventsApiUrl}/all`);
                if (!response.ok) throw new Error('Erro ao buscar eventos.');
                const events = await response.json();
                eventsCache = events; 
                
                if (eventsCache.length === 0) {
                    eventList.innerHTML = '<p>Nenhum evento cadastrado ainda.</p>';
                } else {
                    renderEvents(eventsCache); 
                }
            } catch (error) {
                eventList.innerHTML = `<p style="color: red;">${error.message}</p>`;
            } finally {
                eventLoadingDiv.style.display = 'none';
            }
        }

        function handleEventSearch() {
            const searchTerm = eventSearchInput.value.toLowerCase().trim();
            if (searchTerm === '') {
                renderEvents(eventsCache); 
                return;
            }
            const filteredEvents = eventsCache.filter(e => e.title.toLowerCase().includes(searchTerm));
            renderEvents(filteredEvents);
        }

        window.editEvent = async function(id) {
            try {
                const response = await fetch(`${eventsApiUrl}/${id}`);
                if (!response.ok) throw new Error('Evento n√£o encontrado.');
                const event = await response.json();

                eventIdInput.value = event.id;
                eventForm.title.value = event.title;
                eventForm.image.value = event.image;
                eventForm.alt.value = event.alt; 
                eventForm.description.value = event.description;
                eventForm.date.value = event.date;
                eventForm.date_event.value = event.date_event;
                eventForm.buttonText.value = event.buttonText;
                eventForm.active_event.checked = event.active_event;
                eventForm.cities.value = event.cities ? event.cities.join(', ') : '';

                const currentLink = event.ecommerce_link || '';
                const isWhatsAppLink = currentLink.includes("api.whatsapp.com") && currentLink.includes(whatsappPhone);

                if (isWhatsAppLink || currentLink === '') {
                    linkTypeToggle.checked = false;
                    ecommerceLinkInput.value = '';
                } else {
                    linkTypeToggle.checked = true;
                    ecommerceLinkInput.value = currentLink;
                }
                updateEventLinkUI();

                eventFormTitle.textContent = 'Editando Evento';
                eventSubmitBtn.textContent = 'Salvar Altera√ß√µes';
                eventCancelBtn.style.display = 'inline-block';
                window.scrollTo(0, 0);
                eventSearchInput.value = ''; 
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }

        window.deleteEvent = async function(id) {
            if(!confirm("Tem certeza que deseja excluir este evento?")) return;
            try {
                const response = await fetch(`${eventsApiUrl}/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Falha ao excluir o evento.');
                fetchEvents(); 
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }
        
        function resetEventForm() {
            eventForm.reset();
            eventIdInput.value = '';
            eventFormTitle.textContent = 'Cadastrar Novo Evento';
            eventSubmitBtn.textContent = 'Cadastrar Evento';
            eventCancelBtn.style.display = 'none';
            eventForm.buttonText.value = 'Reservar agora';
            eventForm.alt.value = ''; 
            linkTypeToggle.checked = false; 
            updateEventLinkUI();
            eventSearchInput.value = ''; 
            renderEvents(eventsCache); 
        }

        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = eventIdInput.value;
            const isEditing = !!id;
            const citiesInput = eventForm.cities.value.trim();
            const citiesArray = citiesInput ? citiesInput.split(',').map(city => city.trim()).filter(city => city !== '') : [];
            const eventTitle = eventForm.title.value;
            const dateEventValue = eventForm.date_event.value;
            
            let yearValue = '';
            if (dateEventValue) {
                try { yearValue = dateEventValue.substring(0, 4); } catch(err) {}
            }

            let finalLinkValue = linkTypeToggle.checked ? ecommerceLinkInput.value : generateWhatsappUrl(eventTitle);

            const eventData = {
                image: eventForm.image.value,
                alt: eventForm.alt.value, 
                title: eventTitle,
                date: eventForm.date.value,
                date_event: dateEventValue,
                year: yearValue, 
                description: eventForm.description.value,
                buttonText: eventForm.buttonText.value,
                eventName: eventTitle, 
                cities: citiesArray,
                active_event: eventForm.active_event.checked,
                ecommerce_link: finalLinkValue
            };

            const url = isEditing ? `${eventsApiUrl}/${id}` : eventsApiUrl;
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });
                if (!response.ok) throw new Error('Ocorreu um erro.');
                alert(`Evento ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`);
                resetEventForm();
                fetchEvents(); 
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        });
        
        eventCancelBtn.addEventListener('click', resetEventForm);
        eventSearchInput.addEventListener('input', handleEventSearch);


        // ====================================================
        // L√ìGICA DE LINKTREE
        // ====================================================
        const linkForm = document.getElementById('linktree-form');
        const linkIdInput = document.getElementById('link-id');
        const linkFormTitle = document.getElementById('link-form-title');
        const linkSubmitBtn = document.getElementById('link-submit-btn');
        const linkCancelBtn = document.getElementById('link-cancel-btn');
        const linkList = document.getElementById('link-list');
        const linkLoadingDiv = document.getElementById('link-loading');
        const linkSearchInput = document.getElementById('link-search');

        let linksCache = [];

        function renderLinks(linksToDisplay) {
            linkList.innerHTML = ''; 
            if (linksToDisplay.length === 0) {
                linkList.innerHTML = '<p>Nenhum link encontrado.</p>';
                return;
            }
            linksToDisplay.forEach(link => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="item-details">
                        <div class="link-header">
                            ${link.image_url ? `<img src="${link.image_url}" alt="${link.name}" class="preview-img" onerror="this.style.display='none'">` : ''}
                            <div>
                                <strong>${link.name}</strong>
                                <div><a href="${link.whatsapp_url}" target="_blank" style="color: #25D366; text-decoration: none;">üîó Ver Link WhatsApp</a></div>
                                <div class="status">${link.active ? 'üü¢ Ativo' : 'üî¥ Inativo'} | ID: ${link.id || link._id || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button onclick="editLink('${link.id || link._id}')">Editar</button>
                        <button class="delete-btn" onclick="deleteLink('${link.id || link._id}')">Excluir</button>
                    </div>
                `;
                linkList.appendChild(item);
            });
        }
        
        async function fetchLinks() {
            linkLoadingDiv.style.display = 'block';
            linkList.innerHTML = '';
            try {
                const response = await fetch(`${linktreeApiUrl}/all`);
                if (!response.ok) throw new Error('Erro ao buscar links.');
                const links = await response.json();
                linksCache = links; 
                
                if (linksCache.length === 0) {
                    linkList.innerHTML = '<p>Nenhum link cadastrado ainda.</p>';
                } else {
                    renderLinks(linksCache); 
                }
            } catch (error) {
                linkList.innerHTML = `<p style="color: red;">${error.message}</p>`;
            } finally {
                linkLoadingDiv.style.display = 'none';
            }
        }

        function handleLinkSearch() {
            const searchTerm = linkSearchInput.value.toLowerCase().trim();
            if (searchTerm === '') {
                renderLinks(linksCache); 
                return;
            }
            const filteredLinks = linksCache.filter(link => link.name.toLowerCase().includes(searchTerm));
            renderLinks(filteredLinks);
        }

        window.editLink = async function(id) {
            try {
                const response = await fetch(`${linktreeApiUrl}/${id}`);
                if (!response.ok) throw new Error('Link n√£o encontrado.');
                const link = await response.json();

                linkIdInput.value = link.id || link._id;
                linkForm.name.value = link.name;
                linkForm.image_url.value = link.image_url;
                linkForm.whatsapp_url.value = link.whatsapp_url;
                linkForm.active.checked = link.active;

                linkFormTitle.textContent = 'Editando Link';
                linkSubmitBtn.textContent = 'Salvar Altera√ß√µes';
                linkCancelBtn.style.display = 'inline-block';
                window.scrollTo(0, 0);
                linkSearchInput.value = ''; 
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }

        window.deleteLink = async function(id) {
            if(!confirm("Tem certeza que deseja excluir este link?")) return;
            try {
                const response = await fetch(`${linktreeApiUrl}/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Falha ao excluir o link.');
                fetchLinks(); 
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        }
        
        function resetLinkForm() {
            linkForm.reset();
            linkIdInput.value = '';
            linkFormTitle.textContent = 'Cadastrar Novo Link';
            linkSubmitBtn.textContent = 'Cadastrar Link';
            linkCancelBtn.style.display = 'none';
            linkSearchInput.value = ''; 
            renderLinks(linksCache); 
        }

        linkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = linkIdInput.value;
            const isEditing = !!id;

            const linkData = {
                name: linkForm.name.value,
                image_url: linkForm.image_url.value,
                whatsapp_url: linkForm.whatsapp_url.value,
                active: linkForm.active.checked
            };

            const url = isEditing ? `${linktreeApiUrl}/${id}` : linktreeApiUrl;
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(linkData)
                });
                if (!response.ok) throw new Error('Ocorreu um erro ao salvar o link.');
                alert(`Link ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`);
                resetLinkForm();
                fetchLinks(); 
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        });
        
        linkCancelBtn.addEventListener('click', resetLinkForm);
        linkSearchInput.addEventListener('input', handleLinkSearch);

        // ====================================================
        // INICIALIZA√á√ÉO DA P√ÅGINA
        // ====================================================
        document.addEventListener('DOMContentLoaded', () => {
            fetchEvents();
            updateEventLinkUI();
            fetchLinks();
        });
    </script>
</body>
</html>
